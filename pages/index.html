<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wol Manager</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
<link rel="stylesheet" href="http://localhost:8080/static/css/style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<style type="text/css">
    .bs-example{
    	margin: 20px;
    }
</style>



</head>
<body>


    <div class="container">
      <div class="jumbotron">
        <h3 class="text-center">Remote power management</h3>


        <div class="bs-example">
            <div class="panel-group" id="accordion">
                
            </div>
        </div>


        <footer class="footer">
        </footer>


      </div> <!-- /jumbotron -->
    </div> <!-- /container -->


    <script type="text/javascript">

    var host_request_status = {}




    //request the JSON data and parse into the select element
    //get a reference to the collapsible menu
    $panels = $('#accordion');
    
    $.ajax({
      url: 'http://127.0.0.1:8080/wol/_all',
      dataType:'JSON',
      crossDomain: true,
      success:function(data){
      
        // INIT REQUEST STATUS FOR EACH HOST
        $.each(data, function(key,val){
            var $host = val.name  
            host_request_status[$host] = "No"
        });
        
        //CREATE PANELS
        //clear the current content of the collapsible
        $panels.html('');
        var paneltags = ''
        $.each(data, function(key,val){
          var $host = val.name
          var $mac = val.mac
          paneltags += '\
            <div class="panel panel-default">\
                <div class="panel-heading">\
                    <h4 class="panel-title">\
                        <a data-toggle="collapse" data-parent="#accordion" href="#'+ $host +'">'+ $host +'</a>\
                    </h4>\
                </div>\
                <div id="'+ $host +'" class="panel-collapse collapse">\
                    <div class="panel-body">\
                        <div class="btn-group" role="group" aria-label="...">\
                          <button disabled="disabled" id="'+ $host +'_status" class="btn btn-default">\
                            <div class="spinner"></div>\
                            </button>\
                          <button id="'+ $host +'_power" value="NA" type="button" class="btn btn-default" disabled="disabled">\
                            <span class="glyphicon glyphicon-off" aria-hidden="true"></span> Wait...\
                          </button>\
                        </div>\
                    </div>\
                </div>\
            </div>';          
        });
        $panels.html(paneltags);
        
        // ASSOCIATE AJAX CALLS TO ON/OFF BUTTONS
        $.each(data, function(key,val){
            var $host = val.name          
            $("button#"+$host+"_power").click(function(){
                //Get the button value, which is assumed to return the action name as in the rest url
                var $action = $(this).val()
                $.post("http://127.0.0.1:8080/wol/"+ $host +"/" + $action, {},
                function(data, status){
                  var alert_type = "warning"
                  if (status == "success") {
                    alert_type = "success"  
                    host_request_status[$host] = $action
                  }
                  $("<div class=\"alert alert-"+alert_type+"\" role=\"alert\"/>").html(status+": sent the action '"+$action+"' to "+$host).appendTo("footer.footer")
                });
            });
        });
        
      },
      error:function(){
        //if there is an error append a 'none available' option
        $panels.html('<error id="-1">none available</error>');
      }
    });



        /*
        When a panel is open, check host status and accordingly change status
        */
        $panels.on('show.bs.collapse', '.panel-collapse', function (e) {
            var $target_id = e.currentTarget.id;
            $.getJSON("http://localhost:8080/wol/" + $target_id, function(data) {
                var $status_level = "default";
                var $button_label = "Wait...";
                var $button_value = "NA"
                if (data['status'] == "On") {
                    $status_level = "success";
                    $button_label = "Turn Off";
                    $button_value = "TurnOff"
                } else if (data['status'] == "Off") {
                    $status_level = "warning";
                    $button_label = "Turn On";
                    $button_value = "TurnOn"
                } else {
                    $status_level = "danger";
                }
                $("button#"+$target_id+"_status").attr('class', 'btn btn-'+$status_level);
                $("button#"+$target_id+"_status").text(data['status']);
                $("button#"+$target_id+"_power").attr('value', $button_value);
                $("button#"+$target_id+"_power").removeAttr("disabled");
                $('#'+$target_id+"_power").html('<span class="glyphicon glyphicon-off" aria-hidden="true"></span> ' + $button_label);
            })
        })
        
        
        /*
        When a panel is closed, reset interface to default, ready for next open and check
        */
        $panels.on('hidden.bs.collapse', '.panel-collapse', function (e) {
            var $target_id = e.currentTarget.id;
            $("button#"+$target_id+"_status").attr('class', 'btn btn-default');
            $("button#"+$target_id+"_status").html("<div class=\"spinner\"></div>");
            $("button#"+$target_id+"_power").attr('disabled', 'disabled');
            
            $('#'+$target_id+"_power").html('<span class="glyphicon glyphicon-off" aria-hidden="true"></span> Wait...');
        })



window.setInterval(function(){
  /// call your function here
    $.each(host_request_status, function(host,request){
        if (request!='No') {
        
            alert(host+" got a request: "+request+"Current: "+$("panels button#"+host+"_status").val())
            host_request_status[host] = "No"
        }
    })
}, 30000);



    </script>
</body>
</html>

 
